<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BinPals Operator Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="BinPals Operator – route tools for field teams.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --green: #166534;
      --green-dark: #0f3c22;
      --text-main: #0f172a;
      --text-muted: #4b5563;
      --border: #e5e7eb;
      --pill-gray-bg: #f3f4f6;
      --pill-gray-border: #e5e7eb;
      --pill-gray-text: #4b5563;
      --pill-green-bg: #ecfdf3;
      --pill-green-border: #bbf7d0;
      --pill-green-text: #166534;
      --pill-red-bg: #fef2f2;
      --pill-red-border: #fecaca;
      --pill-red-text: #b91c1c;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      overflow: hidden; /* map hits all edges */
    }

    body {
      position: relative;
      background: #f5f5f5;
    }

    .hidden { display: none !important; }

    /* FULLSCREEN MAP */
    #map {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }

    .map-frame {
      border: 0;
      width: 100%;
      height: 100%;
      display: block;
    }

    /* Floating header (Uber style) */
    .operator-header {
      position: absolute;
      top: 18px;
      left: 18px;
      right: 18px;
      z-index: 20;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      pointer-events: none; /* map can still drag */
    }

    .operator-header-inner {
      display: flex;
      align-items: center;
      gap: 12px;
      pointer-events: auto;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-mark {
      width: 40px;
      height: 40px;
      border-radius: 14px;
      display: grid;
      place-items: center;
      background: radial-gradient(circle at 30% 20%, #4ade80, #22c55e);
      color: #052e16;
      font-weight: 800;
      font-size: 14px;
      box-shadow: 0 16px 30px rgba(22, 101, 52, 0.35);
    }

    .brand-text-title {
      font-weight: 700;
      font-size: 15px;
    }

    .brand-text-sub {
      font-size: 12px;
      color: var(--text-muted);
    }

    .status-pill {
      pointer-events: auto;
      background: #ecfdf3;
      color: #15803d;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      border: 1px solid #bbf7d0;
    }

    /* BOTTOM SHEET */
    .bottom-sheet {
      position: absolute;
      left: 0;
      bottom: 0;
      width: 100%;
      background: #ffffff;
      border-top-left-radius: 26px;
      border-top-right-radius: 26px;
      padding: 18px 18px 26px;
      box-shadow: 0 -18px 40px rgba(15, 23, 42, 0.2);
      z-index: 21;
      transform: translateY(0);
      transition: transform 0.25s ease-out;
      max-height: 70%;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .bottom-sheet.sheet-collapsed {
      transform: translateY(55%);
    }

    .sheet-handle {
      width: 40px;
      height: 5px;
      border-radius: 999px;
      background: #d1d5db;
      margin: 0 auto 12px;
      cursor: pointer;
    }

    .sheet-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
    }

    .tiny-label {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 11px;
      color: var(--text-muted);
    }

    .sheet-title {
      margin: 2px 0 4px;
      font-size: 20px;
      font-weight: 700;
    }

    .stats-pill {
      background: var(--pill-gray-bg);
      border-radius: 999px;
      padding: 8px 12px;
      border: 1px solid var(--pill-gray-border);
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      align-self: flex-start;
      color: var(--pill-gray-text);
    }

    .stats-pill.success {
      background: var(--pill-green-bg);
      border-color: var(--pill-green-border);
      color: var(--pill-green-text);
    }

    .filter-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .filter-row label {
      font-size: 12px;
      color: var(--text-muted);
    }

    #dayFilter {
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f9fafb;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-main);
    }

    /* Current house card */
    .current-stop-card {
      border-radius: 20px;
      border: 1px solid var(--border);
      background: #f9fafb;
      padding: 12px 14px 12px;
    }

    .current-stop-title {
      margin: 0;
      font-size: 15px;
      font-weight: 600;
    }

    .status-pill-small {
      background: var(--pill-gray-bg);
      border-radius: 999px;
      padding: 7px 14px;
      border: 1px solid var(--pill-gray-border);
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--pill-gray-text);
    }

    .status-pill-small.done {
      background: var(--pill-green-bg);
      border-color: var(--pill-green-border);
      color: var(--pill-green-text);
    }

    .status-pill-small.skipped {
      background: var(--pill-red-bg);
      border-color: var(--pill-red-border);
      color: var(--pill-red-text);
    }

    .current-stop-meta {
      font-size: 12px;
      color: var(--text-muted);
      line-height: 1.5;
      margin: 6px 0 10px;
    }

    .current-stop-meta div { margin-bottom: 2px; }
    .current-stop-meta strong { color: var(--text-main); }

    .current-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 9px 14px;
      border-radius: 999px;
      border: none;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      outline: none;
      transition: background-color 0.15s ease, transform 0.07s ease, box-shadow 0.15s ease;
    }

    .btn-primary {
      background: var(--green);
      color: #ffffff;
      box-shadow: 0 10px 18px rgba(22, 101, 52, 0.35);
    }

    .btn-primary:hover { background: var(--green-dark); }
    .btn-primary:active { transform: translateY(1px); box-shadow: 0 6px 12px rgba(22, 101, 52, 0.28); }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn-secondary:hover { background: #d1d5db; }

    .btn-ghost {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      color: #4b5563;
    }
    .btn-ghost:hover {
      background: #f9fafb;
      color: #111827;
    }

    .list-label { margin-top: 2px; }

    .house-list {
      margin-top: 4px;
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .house-row {
      border-radius: 999px;
      border: 1px solid transparent;
      background: #f3f4f6;
      padding: 8px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 12px;
      cursor: pointer;
      transition: background-color 0.12s ease, transform 0.06s ease, border-color 0.12s ease;
    }

    .house-row:hover {
      background: #e5e7eb;
      transform: translateY(-1px);
    }

    .house-row.selected {
      background: #ecfdf3;
      border-color: #bbf7d0;
    }

    .house-row-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
      text-align: left;
    }

    .house-row-address {
      font-weight: 600;
      color: var(--text-main);
    }

    .house-row-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    .house-row-status {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .no-stops {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* LOGIN OVERLAY */
    #loginOverlay {
      position: fixed;
      inset: 0;
      z-index: 50;
      background: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .login-panel {
      width: min(480px, 100%);
      background: #ffffff;
      border-radius: 24px;
      border: 1px solid var(--border);
      box-shadow: 0 26px 60px rgba(15, 23, 42, 0.18);
      padding: 22px 24px 20px;
    }

    .login-panel h1 {
      margin: 0 0 6px;
      font-size: 22px;
    }

    .login-panel p {
      margin: 0 0 14px;
      font-size: 14px;
      color: var(--text-muted);
    }

    .login-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 12px;
    }

    .login-field label {
      font-size: 13px;
      color: var(--text-muted);
    }

    .login-field input {
      width: 100%;
      padding: 11px 14px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f9fafb;
      font-size: 14px;
      color: var(--text-main);
    }

    .login-field input:focus {
      outline: 2px solid rgba(22, 101, 52, 0.35);
      border-color: transparent;
      background: #ffffff;
    }

    .login-error {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: #fef2f2;
      color: #b91c1c;
      font-size: 13px;
      font-weight: 600;
      border: 1px solid #fecaca;
    }

    .login-btn {
      width: 100%;
      margin-top: 4px;
      padding-block: 11px;
    }

    /* Responsive */
    @media (min-width: 900px) {
      .bottom-sheet {
        left: 50%;
        width: 420px;
        transform: translate(0, 0);
        translate: -50% 0;
        border-radius: 24px;
        bottom: 22px;
        max-height: 60%;
      }

      .bottom-sheet.sheet-collapsed {
        transform: translate(-50%, 40%);
      }

      .operator-header {
        left: 50%;
        translate: -50% 0;
        max-width: 960px;
      }
    }

    @media (max-width: 640px) {
      .operator-header {
        top: 14px;
        left: 14px;
        right: 14px;
      }

      .bottom-sheet {
        padding-inline: 16px;
        border-top-left-radius: 24px;
        border-top-right-radius: 24px;
      }
    }
  </style>
</head>
<body>

  <!-- Uber-style header -->
  <header class="operator-header">
    <div class="operator-header-inner">
      <div class="brand">
        <div class="brand-mark">BP</div>
        <div>
          <div class="brand-text-title">BinPals Operator</div>
          <div class="brand-text-sub">Route tools for field teams</div>
        </div>
      </div>
    </div>
    <div id="userBadge" class="status-pill hidden">Logged in</div>
  </header>

  <!-- FULLSCREEN MAP (your My Map embed) -->
  <div id="map">
    <iframe
      class="map-frame"
      src="https://www.google.com/maps/d/embed?mid=1tsQ261TBSD6vD471LMMBVzrEt40zuyw&ehbc=2E312F"
      loading="lazy">
    </iframe>
  </div>

  <!-- BOTTOM SHEET -->
  <section class="bottom-sheet sheet-collapsed" id="bottomSheet">
    <div class="sheet-handle" id="sheetHandle"></div>

    <div class="sheet-header">
      <div>
        <div class="tiny-label" id="todayLabel">Today · Sunday</div>
        <h2 class="sheet-title">Today’s route</h2>
      </div>
      <div id="statsPill" class="stats-pill">0 left today / 0 total</div>
    </div>

    <div class="filter-row">
      <label for="dayFilter">Trash day</label>
      <select id="dayFilter">
        <option value="today">Today only</option>
        <option value="all">All days</option>
        <option>Monday</option>
        <option>Tuesday</option>
        <option>Wednesday</option>
        <option>Thursday</option>
        <option>Friday</option>
        <option>Saturday</option>
      </select>
    </div>

    <div id="currentStopCard" class="current-stop-card"></div>

    <div class="list-label tiny-label">Houses</div>
    <div id="houseList" class="house-list"></div>
    <p id="noStopsMessage" class="no-stops" style="display:none;">No houses for this filter.</p>
  </section>

  <!-- LOGIN OVERLAY -->
  <div id="loginOverlay">
    <div class="login-panel">
      <h1>Operator login</h1>
      <p>Use your BinPals operator credentials to access today’s route.</p>
      <form id="loginForm" novalidate>
        <div class="login-field">
          <label for="email">Email</label>
          <input type="email" id="email" name="email"
                 placeholder="operator@getbinpals.com"
                 autocomplete="username" required>
        </div>
        <div class="login-field">
          <label for="password">Password</label>
          <input type="password" id="password" name="password"
                 placeholder="••••••••" autocomplete="current-password" required>
        </div>
        <button type="submit" class="btn btn-primary login-btn">Login</button>
        <div id="loginError" class="login-error hidden">
          Incorrect email or password.
        </div>
      </form>
    </div>
  </div>

  <script>
    /***********************
     * SIMPLE STATE + DATA
     ***********************/
    const ALLOWED_USERS = [
      { email: "operator@getbinpals.com", password: "route123" }
    ];

    // Replace this with data from your sheet later
    const STOPS = [
      {
        id: 1,
        customerRow: 5,
        name: "Garcia Family",
        fullAddress: "12345 N Desert Cactus Dr, Peoria AZ",
        plan: "Premium – $45/mo",
        phone: "555-555-0001",
        email: "garcia@example.com",
        day: "Sunday",
        binStatus: "Pending"
      },
      {
        id: 2,
        customerRow: 8,
        name: "Lopez Home",
        fullAddress: "9876 W Binpals Way, Peoria AZ",
        plan: "Basic – $35/mo",
        phone: "",
        email: "lopez@example.com",
        day: "Sunday",
        binStatus: "Pending"
      },
      {
        id: 3,
        customerRow: 12,
        name: "Taylor Household",
        fullAddress: "5555 W Route Runner Rd, Peoria AZ",
        plan: "Premium – $45/mo",
        phone: "555-555-0002",
        email: "taylor@example.com",
        day: "Monday",
        binStatus: "Done"
      }
    ];

    const weekdayNames = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];

    let stopsState = STOPS.map(s => ({ ...s }));
    let selectedStopId = null;

    /***********************
     * DOM
     ***********************/
    const loginForm      = document.getElementById("loginForm");
    const loginOverlay   = document.getElementById("loginOverlay");
    const loginError     = document.getElementById("loginError");
    const userBadge      = document.getElementById("userBadge");

    const todayLabel     = document.getElementById("todayLabel");
    const dayFilter      = document.getElementById("dayFilter");
    const statsPill      = document.getElementById("statsPill");

    const currentStopCard = document.getElementById("currentStopCard");
    const houseList       = document.getElementById("houseList");
    const noStopsMessage  = document.getElementById("noStopsMessage");

    const bottomSheet   = document.getElementById("bottomSheet");
    const sheetHandle   = document.getElementById("sheetHandle");

    /***********************
     * HELPERS
     ***********************/
    function getTodayName() {
      const now = new Date();
      return weekdayNames[now.getDay()];
    }

    function setInitialDayFilter() {
      const todayName = getTodayName();
      todayLabel.textContent = `Today · ${todayName}`;
      dayFilter.value = "today";
      dayFilter.dataset.today = todayName;
    }

    function authenticate(email, password) {
      const cleaned = email.trim().toLowerCase();
      return ALLOWED_USERS.some(
        u => u.email.toLowerCase() === cleaned && u.password === password
      );
    }

    function getFilteredStops() {
      const value = dayFilter.value;
      if (value === "today") {
        const todayName = dayFilter.dataset.today || getTodayName();
        return stopsState.filter(s => s.day === todayName);
      }
      if (value === "all") return stopsState;
      return stopsState.filter(s => s.day === value);
    }

    function getTodayStopsOnly() {
      const todayName = dayFilter.dataset.today || getTodayName();
      return stopsState.filter(s => s.day === todayName);
    }

    function getNextPendingStop(stops) {
      return stops.find(s => s.binStatus === "Pending") || stops[0] || null;
    }

    /***********************
     * RENDER
     ***********************/
    function renderView() {
      const filtered = getFilteredStops();

      if (!selectedStopId) {
        const next = getNextPendingStop(filtered);
        selectedStopId = next ? next.id : null;
      }

      renderCurrentStop(filtered);
      renderHouseList(filtered);
      updateStats();
    }

    function renderCurrentStop(filteredStops) {
      const current = selectedStopId
        ? stopsState.find(s => s.id === selectedStopId)
        : getNextPendingStop(filteredStops);

      if (!current) {
        currentStopCard.innerHTML = `
          <div class="tiny-label">Current house</div>
          <p class="no-stops">No houses for this filter.</p>
        `;
        return;
      }

      selectedStopId = current.id;

      const statusClass =
        current.binStatus === "Done"
          ? "done"
          : current.binStatus === "Skipped"
          ? "skipped"
          : "";

      currentStopCard.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px;">
          <div>
            <div class="tiny-label">Current house</div>
            <p class="current-stop-title">${current.fullAddress}</p>
            <p class="brand-text-sub" style="margin:2px 0 0; font-size:12px;">
              ${current.name || "Customer"}
            </p>
          </div>
          <span class="status-pill-small ${statusClass}">${current.binStatus}</span>
        </div>
        <div class="current-stop-meta">
          <div><strong>Plan:</strong> ${current.plan}</div>
          <div><strong>Phone:</strong> ${current.phone || "—"}</div>
          <div><strong>Trash day:</strong> ${current.day}</div>
          <div><strong>Row:</strong> ${current.customerRow}</div>
        </div>
        <div class="current-actions">
          <button class="btn btn-primary" data-action="done" data-id="${current.id}">Done</button>
          <button class="btn btn-secondary" data-action="skipped" data-id="${current.id}">Skipped</button>
          <button class="btn btn-ghost" data-action="contact" data-id="${current.id}">Contact</button>
        </div>
      `;
    }

    function renderHouseList(stops) {
      houseList.innerHTML = "";
      noStopsMessage.style.display = stops.length ? "none" : "block";

      stops.forEach((stop, index) => {
        const row = document.createElement("button");
        row.type = "button";
        row.className = "house-row" + (stop.id === selectedStopId ? " selected" : "");
        row.dataset.id = stop.id;

        row.innerHTML = `
          <div class="house-row-main">
            <span class="house-row-address">${index + 1}. ${stop.fullAddress}</span>
            <span class="house-row-sub">${stop.plan} · ${stop.day} · Row ${stop.customerRow}</span>
          </div>
          <span class="house-row-status">${stop.binStatus}</span>
        `;

        row.addEventListener("click", () => setSelectedStop(stop.id));
        houseList.appendChild(row);
      });
    }

    function updateStats() {
      const today = getTodayStopsOnly();
      const left  = today.filter(s => s.binStatus === "Pending").length;
      const total = today.length;
      statsPill.textContent = `${left} left today / ${total} total`;
      statsPill.className = left === 0 && total > 0 ? "stats-pill success" : "stats-pill";
    }

    function setSelectedStop(id) {
      selectedStopId = id;
      const filtered = getFilteredStops();
      renderCurrentStop(filtered);
      renderHouseList(filtered);
      updateStats();
    }

    function handleStatusChange(stopId, newStatus) {
      const stop = stopsState.find(s => s.id === stopId);
      if (!stop) return;
      stop.binStatus = newStatus;
      // FUTURE: Twilio / email trigger goes here
      renderView();
    }

    function handleContact(stopId) {
      const stop = stopsState.find(s => s.id === stopId);
      if (!stop) return;

      if (stop.phone) {
        const cleaned = stop.phone.replace(/[^0-9]/g, "");
        if (cleaned) {
          window.location.href = `tel:${cleaned}`;
          return;
        }
      }
      alert(`Contact ${stop.name || "customer"} at ${stop.email || "saved email"}.`);
    }

    /***********************
     * EVENTS
     ***********************/
    // Login
    loginForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const email = loginForm.email.value;
      const password = loginForm.password.value;

      if (authenticate(email, password)) {
        loginError.classList.add("hidden");
        loginOverlay.classList.add("hidden");
        userBadge.classList.remove("hidden");
      } else {
        loginError.classList.remove("hidden");
      }
    });

    // Filter change
    dayFilter.addEventListener("change", () => {
      selectedStopId = null;
      renderView();
    });

    // Current house buttons
    currentStopCard.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-action]");
      if (!btn) return;
      const stopId = Number(btn.dataset.id);
      const action = btn.dataset.action;

      if (action === "done")    handleStatusChange(stopId, "Done");
      if (action === "skipped") handleStatusChange(stopId, "Skipped");
      if (action === "contact") handleContact(stopId);
    });

    // Sheet collapse / expand
    sheetHandle.addEventListener("click", () => {
      bottomSheet.classList.toggle("sheet-collapsed");
    });

    /***********************
     * INIT
     ***********************/
    setInitialDayFilter();
    renderView();
  </script>
</body>
</html>
